{{#*inline "content"}}
<div class="page-header">
    <h1>Public Keys Management</h1>
    <p>Manage allowed users and their public keys</p>
</div>

<div class="keys-container">
    <div class="keys-actions">
        <button class="add-key-btn" onclick="showAddKeyForm()">
            <span class="btn-icon">+</span>
            Add New Key
        </button>
    </div>

    <!-- Add Key Form (initially hidden) -->
    <div id="add-key-form" class="add-key-form" style="display: none;">
        <div class="form-card">
            <h3>Add New Public Key</h3>
            <form method="post" action="/keys" class="key-form">
                <div class="form-group">
                    <label for="npub">Public Key (npub)</label>
                    <input 
                        type="text" 
                        id="npub" 
                        name="npub" 
                        required 
                        placeholder="npub1..."
                        pattern="^npub1[a-z0-9]{58}$"
                        title="Enter a valid Nostr public key starting with npub1"
                    >
                    <small class="form-help">Enter a valid Nostr public key (npub1...)</small>
                </div>
                
                <div class="form-group">
                    <label for="nip05">NIP-05 Identifier (Optional)</label>
                    <input 
                        type="text" 
                        id="nip05" 
                        name="nip05" 
                        placeholder="user@example.com"
                        pattern="^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$"
                        title="Enter a valid email address"
                    >
                    <small class="form-help">Optional: NIP-05 identifier for profile verification</small>
                </div>
                
                <div class="form-group">
                    <label for="profile_name">Display Name (Optional)</label>
                    <input 
                        type="text" 
                        id="profile_name" 
                        name="profile_name" 
                        placeholder="John Doe"
                    >
                    <small class="form-help">Optional: Human-readable name for this key</small>
                </div>
                
                <div class="form-actions">
                    <button type="submit" class="submit-btn">
                        Add Key
                    </button>
                    <button type="button" class="cancel-btn" onclick="hideAddKeyForm()">
                        Cancel
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Keys List -->
    <div class="keys-list">
        {{#if keys}}
        <div class="keys-table-container">
            <table class="keys-table">
                <thead>
                    <tr>
                        <th>Public Key</th>
                        <th>NIP-05</th>
                        <th>Display Name</th>
                        <th>Status</th>
                        <th>Added</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {{#each keys}}
                    <tr>
                        <td class="key-cell">
                            <code class="npub">{{this.npub}}</code>
                            <button class="copy-btn" onclick="copyToClipboard('{{this.npub}}')" title="Copy key">
                                ðŸ“‹
                            </button>
                        </td>
                        <td class="nip05-cell">
                            {{#if this.nip05}}
                                <span class="nip05">{{this.nip05}}</span>
                            {{else}}
                                <span class="no-nip05">â€”</span>
                            {{/if}}
                        </td>
                        <td class="name-cell">
                            {{#if this.profile_name}}
                                <span class="profile-name">{{this.profile_name}}</span>
                            {{else}}
                                <span class="no-name">â€”</span>
                            {{/if}}
                        </td>
                        <td class="status-cell">
                            <span class="status-badge {{#if this.status}}status-enabled{{else}}status-disabled{{/if}}">
                                {{#if this.status}}Enabled{{else}}Disabled{{/if}}
                            </span>
                        </td>
                        <td class="date-cell">
                            <span class="date">{{this.created_at}}</span>
                        </td>
                        <td class="actions-cell">
                            <div class="action-buttons">
                                <form method="post" action="/keys/{{this.id}}/toggle" class="inline-form">
                                    <button type="submit" class="toggle-btn {{#if this.status}}disable{{else}}enable{{/if}}" 
                                            title="{{#if this.status}}Disable{{else}}Enable{{/if}} key">
                                        {{#if this.status}}Disable{{else}}Enable{{/if}}
                                    </button>
                                </form>
                                <form method="post" action="/keys/{{this.id}}/delete" class="inline-form" 
                                      onsubmit="return confirm('Are you sure you want to delete this key? This action cannot be undone.')">
                                    <button type="submit" class="delete-btn" title="Delete key">
                                        Delete
                                    </button>
                                </form>
                            </div>
                        </td>
                    </tr>
                    {{/each}}
                </tbody>
            </table>
        </div>
        {{else}}
        <div class="empty-state">
            <div class="empty-icon">ðŸ”‘</div>
            <h3>No Public Keys</h3>
            <p>You haven't added any public keys yet. Add your first key to get started.</p>
            <button class="add-first-key-btn" onclick="showAddKeyForm()">
                Add Your First Key
            </button>
        </div>
        {{/if}}
    </div>

    <!-- Messages -->
    {{#if error_message}}
    <div class="error-message">
        {{error_message}}
    </div>
    {{/if}}
    
    {{#if success_message}}
    <div class="success-message">
        {{success_message}}
    </div>
    {{/if}}
</div>

<script>
function showAddKeyForm() {
    document.getElementById('add-key-form').style.display = 'block';
    document.getElementById('npub').focus();
}

function hideAddKeyForm() {
    document.getElementById('add-key-form').style.display = 'none';
    // Reset form
    document.querySelector('.key-form').reset();
}

function copyToClipboard(text) {
    navigator.clipboard.writeText(text).then(function() {
        // Show temporary success feedback
        const button = event.target;
        const originalText = button.textContent;
        button.textContent = 'âœ“';
        button.style.color = '#4caf50';
        
        setTimeout(() => {
            button.textContent = originalText;
            button.style.color = '';
        }, 1000);
    }).catch(function(err) {
        console.error('Failed to copy: ', err);
        alert('Failed to copy to clipboard');
    });
}

// Auto-hide messages after 5 seconds
document.addEventListener('DOMContentLoaded', function() {
    const messages = document.querySelectorAll('.error-message, .success-message');
    messages.forEach(function(message) {
        setTimeout(function() {
            message.style.opacity = '0';
            setTimeout(function() {
                message.remove();
            }, 300);
        }, 5000);
    });
});
</script>
{{/inline}}

{{> layout title="Keys" show_nav=true}}
